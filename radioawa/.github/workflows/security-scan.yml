name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

# Limit concurrent runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Backend Dependency Scanning (Maven)
  backend-dependencies:
    name: Backend Dependencies (Trivy)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write  # Upload to GitHub Security tab

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (Maven)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './backend'
          scanners: 'vuln'
          format: 'sarif'
          output: 'trivy-backend-deps.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'  # Don't fail on vulnerabilities (report only)

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-backend-deps.sarif'
          category: 'backend-dependencies'

      - name: Run Trivy (fail on critical/high)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './backend'
          scanners: 'vuln'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail build on critical/high vulnerabilities

      - name: Archive vulnerability report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-vulnerability-report
          path: trivy-backend-deps.sarif
          retention-days: 30

  # Frontend Dependency Scanning (npm)
  frontend-dependencies:
    name: Frontend Dependencies (npm audit + Trivy)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run npm audit
        run: |
          cd frontend
          npm audit --audit-level=high --json > npm-audit-report.json || true
          npm audit --audit-level=high

      - name: Run Trivy vulnerability scanner (npm)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './frontend'
          scanners: 'vuln'
          format: 'sarif'
          output: 'trivy-frontend-deps.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-frontend-deps.sarif'
          category: 'frontend-dependencies'

      - name: Run Trivy (fail on critical/high)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './frontend'
          scanners: 'vuln'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Archive vulnerability reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-vulnerability-report
          path: |
            trivy-frontend-deps.sarif
            frontend/npm-audit-report.json
          retention-days: 30

  # Docker Image Scanning
  docker-images:
    name: Docker Images (Trivy)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    strategy:
      matrix:
        image:
          - name: backend
            dockerfile: ./backend/Dockerfile
            context: ./backend
          - name: frontend
            dockerfile: ./frontend/Dockerfile
            context: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image.context }}
          file: ${{ matrix.image.dockerfile }}
          push: false
          load: true
          tags: radioawa-${{ matrix.image.name }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner (Docker)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: radioawa-${{ matrix.image.name }}:test
          format: 'sarif'
          output: 'trivy-${{ matrix.image.name }}-image.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.image.name }}-image.sarif'
          category: '${{ matrix.image.name }}-docker-image'

      - name: Run Trivy (fail on critical/high)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: radioawa-${{ matrix.image.name }}:test
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Archive vulnerability report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.image.name }}-docker-vulnerability-report
          path: trivy-${{ matrix.image.name }}-image.sarif
          retention-days: 30

  # Secret Scanning
  secret-scanning:
    name: Secret Detection (Trivy)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better secret detection

      - name: Run Trivy secret scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'secret'
          format: 'sarif'
          output: 'trivy-secrets.sarif'
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-secrets.sarif'
          category: 'secrets'

      - name: Run Trivy secret scanner (fail on secrets)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'secret'
          format: 'table'
          exit-code: '1'  # Fail if secrets detected

      - name: Archive secret scan report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secret-scan-report
          path: trivy-secrets.sarif
          retention-days: 30

  # Security Summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [backend-dependencies, frontend-dependencies, docker-images, secret-scanning]
    if: always()

    steps:
      - name: Check security scan results
        run: |
          echo "Security Scan Summary"
          echo "===================="
          echo "Backend Dependencies: ${{ needs.backend-dependencies.result }}"
          echo "Frontend Dependencies: ${{ needs.frontend-dependencies.result }}"
          echo "Docker Images: ${{ needs.docker-images.result }}"
          echo "Secret Scanning: ${{ needs.secret-scanning.result }}"
          echo ""

          if [[ "${{ needs.backend-dependencies.result }}" != "success" ]]; then
            echo "âŒ Backend dependency vulnerabilities detected"
          fi

          if [[ "${{ needs.frontend-dependencies.result }}" != "success" ]]; then
            echo "âŒ Frontend dependency vulnerabilities detected"
          fi

          if [[ "${{ needs.docker-images.result }}" != "success" ]]; then
            echo "âŒ Docker image vulnerabilities detected"
          fi

          if [[ "${{ needs.secret-scanning.result }}" != "success" ]]; then
            echo "ğŸš¨ SECRETS DETECTED - Review immediately!"
            exit 1
          fi

          if [[ "${{ needs.backend-dependencies.result }}" == "success" ]] && \
             [[ "${{ needs.frontend-dependencies.result }}" == "success" ]] && \
             [[ "${{ needs.docker-images.result }}" == "success" ]] && \
             [[ "${{ needs.secret-scanning.result }}" == "success" ]]; then
            echo "âœ… All security scans passed!"
          else
            echo "âš ï¸  Some security issues detected - review the reports"
            exit 1
          fi

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              backend: '${{ needs.backend-dependencies.result }}',
              frontend: '${{ needs.frontend-dependencies.result }}',
              docker: '${{ needs.docker-images.result }}',
              secrets: '${{ needs.secret-scanning.result }}'
            };

            const emoji = (result) => result === 'success' ? 'âœ…' : 'âŒ';

            const body = `## ğŸ”’ Security Scan Results

            | Scan Type | Status |
            |-----------|--------|
            | Backend Dependencies | ${emoji(results.backend)} ${results.backend} |
            | Frontend Dependencies | ${emoji(results.frontend)} ${results.frontend} |
            | Docker Images | ${emoji(results.docker)} ${results.docker} |
            | Secret Detection | ${emoji(results.secrets)} ${results.secrets} |

            ${results.secrets !== 'success' ? 'ğŸš¨ **SECRETS DETECTED** - Review immediately!\n' : ''}

            View detailed reports in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning) or download artifacts from this workflow run.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
